name: Update Usage Metrics

on:
  schedule:
    # Run monthly on the 1st at 9 AM UTC
    - cron: '0 9 1 * *'
  workflow_dispatch:
    inputs:
      versions:
        description: 'Comma-separated versions to query (leave empty for all versions)'
        required: false
        default: ''

permissions:
  contents: write

jobs:
  collect-metrics:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Go
        uses: actions/setup-go@44694675825211faa026b3c33043df3e48a5fa00 # v6.0.0
        with:
          go-version-file: 'usage-metrics/go.mod'

      - name: Query versions
        id: query
        working-directory: usage-metrics
        run: |
          # Get versions to query
          VERSIONS="${{ github.event.inputs.versions }}"
          if [ -z "$VERSIONS" ]; then
            # Get all versions from v0.13.0 to latest
            VERSIONS=$(git ls-remote --tags origin | \
              grep -E 'refs/tags/v0\.[0-9]+\.0$' | \
              sed 's|.*refs/tags/||' | \
              sort -V | \
              awk '/v0.13.0/,0' | \
              tr '\n' ',' | \
              sed 's/,$//')
          fi

          echo "Querying versions: $VERSIONS"

          # Build version flags
          VERSION_FLAGS=""
          IFS=',' read -ra VERSION_ARRAY <<< "$VERSIONS"
          for version in "${VERSION_ARRAY[@]}"; do
            version=$(echo "$version" | xargs) # trim whitespace
            if [ -z "$version" ]; then
              continue
            fi
            VERSION_FLAGS="$VERSION_FLAGS -version $version"
          done

          # Query all versions in a single command
          go run collect-metrics.go $VERSION_FLAGS -csv "../../docs/usage-metrics.csv"

      - name: Create Pull Request
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/usage-metrics.csv

          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          # Create a new branch for the PR
          DATE=$(date +%Y-%m-%d)
          BRANCH_NAME="chore/update-usage-metrics-$DATE"
          git checkout -b "$BRANCH_NAME"

          git commit -m "chore(metrics): update usage metrics ($DATE)"
          git push -u origin "$BRANCH_NAME"

          # Create PR using gh CLI
          gh pr create \
            --title "chore: update usage metrics ($DATE)" \
            --body "Automated update of usage metrics data. This PR updates the usage metrics CSV file with the latest GitHub usage data for testcontainers-go versions." \
            --base main
